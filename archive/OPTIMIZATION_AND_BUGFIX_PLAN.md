# План Оптимизации и Исправления Багов (Ultimate SEO Pipeline)

**Дата:** 13 декабря 2025  
**Статус:** Ready for Production  
**Версия архитектуры:** 5.0 (Sub-agents + Python Scripts)

---

## 1. Концепция проекта

Проект представляет собой **автоматизированный конвейер (pipeline)** для создания SEO-контента интернет-магазина автохимии Ultimate.net.ua.

### Основные принципы:
*   **Стандарт:** SEO v7.3 "Shop Mode" (Buying Guides). Тексты ориентированы на помощь в выборе товара, а не энциклопедические статьи.
*   **Архитектура:** Orchestrator (управление задачами) + Sub-agents (Prepare/Produce/Deliver).
*   **Технологический стек:** Python (скрипты валидации и подготовки данных) + LLM (генерация контента).
*   **Валидация:** Жесткий контроль метрик (Water, Nausea, Density, Commercial Markers) через `quality_runner.py` перед приемкой.

---

## 2. Текущая Архитектура и Статус

### Структура данных
*   **SSOT (Единый источник правды):** `SEO_MASTER.md` и `scripts/seo_utils.py`.
*   **Входные данные:** `data/Структура Ultimate финал - Лист2.csv` (семантика) и `data/поисковая_выдача_топ_10.csv` (SERP).
*   **Рабочее пространство:** `categories/{slug}/` (изолированная папка для каждой категории).
*   **Управление состоянием:** `task_{slug}.json` (файл-чекпоинт).

### Статус компонентов
| Компонент | Статус | Комментарий |
|-----------|--------|-------------|
| **Orchestrator** (`setup_all.py`) | ✅ Stable | Создает папки, task-файлы и JSON с семантикой. |
| **Data Parser** (`parse_semantics_to_json.py`) | ✅ Fixed | Исправлена ошибка границ L3 и пустых строк. Покрыт тестами. |
| **Validator** (`quality_runner.py`) | ✅ Stable | Реализует 7 проверок. Пороги синхронизированы с v7.3. |
| **Utils** (`seo_utils.py`) | ✅ SSOT | Централизованное хранилище правил Tier A/B/C. |
| **NER Check** (`check_ner_brands.py`) | ✅ Stable | Интеграция с Natasha, жесткие блэклисты брендов/городов. |
| **URL Extractor** (`extract_competitor_urls_v2.py`) | ⚠️ Review | Рабочий, но требует проверки путей входных данных. |

---

## 3. Исправленные Баги (Audit Report)

В ходе глубокого аудита были выявлены и устранены следующие критические проблемы:

1.  **Ошибка парсера семантики:**
    *   *Было:* Скрипт `parse_semantics_to_json.py` терял ключевые слова из-за некорректной обработки пустых строк и заголовков внутри CSV.
    *   *Стало:* Логика переписана, добавлены Unit-тесты (`tests/test_parse_semantics_to_json.py`). Теперь `keywords.json` генерируется корректно.

2.  **Рассинхронизация порогов качества:**
    *   *Было:* `quality_runner.py` использовал жестко закодированные значения (Nausea < 2.5), противоречащие `SEO_MASTER.md`.
    *   *Стало:* Все пороги вынесены в `seo_utils.py`. `quality_runner.py` импортирует их динамически.

3.  **Хаос в файловой структуре:**
    *   *Было:* Дубликаты скриптов в корне и папке `scripts/`, смешение legacy bash-скриптов.
    *   *Стало:* Все рабочие скрипты в `scripts/`. Legacy перемещено в `archive/`.

---

## 4. План Оптимизации (Roadmap)

### Этап 1: Масштабирование (Batch Init)
*Цель: Подготовить рабочее пространство для всех 9 категорий.*

1.  Запустить `python3 scripts/setup_all.py --force`.
    *   Это пересоздаст `keywords.json` для всех категорий, используя исправленный парсер.
    *   Создаст актуальные `task_{slug}.json`.

### Этап 2: Сбор данных конкурентов
*Цель: Обеспечить агента ссылками для анализа (LSI/структура).*

1.  Проверить актуальность `data/поисковая_выдача_топ_10.csv`.
2.  Запустить массовое извлечение URL:
    ```bash
    # Пример для одной категории
    python3 scripts/extract_competitor_urls_v2.py --slug aktivnaya-pena
    ```
    *Необходимо создать обертку или добавить цикл в `setup_all.py` для запуска по всем категориям, либо запускать по требованию агента.*

### Этап 3: Генерация контента (Production Run)
*Цель: Получить финальные тексты.*

Использовать Sub-agent workflow для каждой категории:
1.  **Prepare:** Уже выполнено на Этапе 1.
2.  **Produce:** Запуск агента-писателя (Sonnet).
    *   Вход: `task_{slug}.json`, `keywords.json`.
    *   Выход: `content/{slug}_ru.md`, `meta/{slug}_meta.json`.
3.  **Deliver:** Запуск агента-аудитора.
    *   Действие: Запуск `quality_runner.py`.
    *   Результат: Если FAIL — отправка на доработку (Edit), если PASS — упаковка в `deliverables/`.

### Этап 4: Финальная зачистка
1.  Удалить `archive/` из репозитория (или добавить в `.gitignore`), если файлы больше не нужны для истории.
2.  Сгенерировать сводный отчет по всем категориям (Total Word Count, Average Quality Score).

---

## 5. Инструкция по запуску (Quick Start)

Для старта работы над следующей категорией (`glina-i-avtoskraby`):

1.  **Инициализация (с исправленным парсером):**
    ```bash
    python3 scripts/setup_all.py --force
    ```

2.  **Проверка генерации JSON:**
    ```bash
    cat categories/glina-i-avtoskraby/data/glina-i-avtoskraby.json | head -n 20
    ```

3.  **Запуск генерации (команда агенту):**
    > "контент для glina-i-avtoskraby"

4.  **Ручная проверка (опционально):**
    ```bash
    python3 scripts/quality_runner.py categories/glina-i-avtoskraby/content/glina-i-avtoskraby_ru.md "глина для авто" A
    ```
