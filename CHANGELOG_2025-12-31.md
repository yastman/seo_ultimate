# Changelog 2025-12-31: Синхронизация семантики CSV → \_clean.json

## Проблема

Файлы `_clean.json` содержали:

1. Ключи, которых нет в исходном CSV (добавлены вручную с ошибками)
2. Неправильные volumes (отличались от CSV)
3. Много ключей из CSV вообще не были добавлены в \_clean.json ("сироты")

**Было:** ~528 ключей в \_clean.json, ~47% покрытия CSV

## Что сделано

### 1. Создан скрипт `compare_raw_clean.py`

- Сравнивает CSV семантику с \_clean.json файлами
- Показывает расхождения: добавленные, удалённые, изменённые volumes
- Режим `--fix` автоматически исправляет ошибки

### 2. Создан скрипт `restore_from_csv.py`

- Восстанавливает \_clean.json из CSV для категорий с 0 ключами
- Поддерживает основные блоки (L2/L3) и под-блоки (Наборы)

### 3. Создан скрипт `find_orphan_keywords.py`

- Парсит ВСЕ ключи из CSV (игнорируя структуру блоков)
- Находит "сирот" — ключи в CSV, которых нет в \_clean.json
- Автоматически распределяет по категориям на основе паттернов
- Режимы: анализ / dry-run / apply

### 4. Исправлен `config.py`

- Обновлён путь к CSV: `PROJECT_ROOT / "Структура _Ultimate.csv"`

## Результат (финальный)

| Метрика               | До   | После       |
| --------------------- | ---- | ----------- |
| Категорий             | 66   | 66          |
| Ключей в \_clean.json | ~528 | **1159**    |
| Общий volume          | ~50k | **109,370** |
| Покрытие CSV          | ~47% | **100%**    |
| Сироты                | 606  | **0**       |

## Файлы изменены

### Скрипты (новые)

- `scripts/compare_raw_clean.py` — сравнение CSV vs \_clean.json
- `scripts/restore_from_csv.py` — восстановление из CSV
- `scripts/find_orphan_keywords.py` — поиск и распределение сирот
- `scripts/cleanup_misplaced.py` — очистка неправильно размещённых ключей

### Скрипты (обновлены)

- `scripts/config.py` — исправлен путь к CSV
- `scripts/README.md` — документация
- `scripts/validate_uk.py` — обновлена структура мета-полей

### Данные (\_clean.json)

Обновлены все 66 категорий:

- Удалены ключи, которых нет в CSV
- Исправлены volumes
- Добавлены недостающие ключи из CSV

---

## Выполненные задачи (сессия 2)

### ✅ Сделано

1. **Добавлены паттерны для всех оставшихся сирот**
   - Исправлена функция `suggest_category()` — теперь выбирает по приоритету
   - Добавлено 20+ новых паттернов для оборудования, двигателя, шин, скотча и др.
   - Результат: **0 сирот, 100% покрытие CSV**

2. **Создан `cleanup_misplaced.py`**
   - Находит ключи в неправильных категориях
   - Режим `--fix` автоматически перемещает

3. **Исправлен `validate_uk.py`**
   - Обновлена структура мета-полей (h1, meta.title, meta.description)

4. **Проверена UK версия**
   - 34 категории (из 66 RU)
   - 9 PASS, 4 WARNING, 21 FAIL (отсутствует контент)

### ⏳ Требуется дальше

1. **Сгенерировать UK контент** для 21 категории:
   ```bash
   /content-generator {slug} --lang uk
   ```

2. **Регенерировать RU контент** для категорий с существенно изменённой семантикой:
   - dlya-khimchistki-salona: +69 ключей
   - aktivnaya-pena: +47 ключей
   - mikrofibra-i-tryapki: +36 ключей
   - polirovalnye-mashinki: +31 ключ

### Поддержка

- **При добавлении новых ключей в CSV:**
  ```bash
  python3 scripts/find_orphan_keywords.py --distribute --apply
  python3 scripts/cleanup_misplaced.py --fix
  ```

- **Периодическая проверка соответствия:**
  ```bash
  python3 scripts/compare_raw_clean.py
  python3 scripts/cleanup_misplaced.py
  ```

---

## Структура CSV (напоминание)

```
L1: Мойка и Экстерьер          ← Хаб (нет своих ключей)
  L2: Автошампуни              ← L2 категория
    L3: Активная пена          ← L3 с ключами
    L3: Для ручной мойки       ← L3 с ключами
    SEO-Фильтр: С воском       ← SEO-фильтр
  L2: Средства для стекол
    Омыватель                  ← Спец-блок (без L3:)
    Антидождь                  ← Спец-блок
...
Наборы                         ← Родительский блок
  набор для мойки авто         ← Под-блок с ключами
  наборы для детейлинга        ← Под-блок с ключами
```

Не все блоки имеют префикс L1/L2/L3 — скрипты это учитывают.
